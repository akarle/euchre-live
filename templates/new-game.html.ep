<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Euchre Live!</title>
<link href="suits/H.svg" rel="icon"  type="image/x-icon" />
<link rel="stylesheet" href="debug.css">
</head>
<body>
<script>
let GAME_PHASE = '';
let SEAT = -1;
const player_name = "<%= $username %>";
const table = "<%= $gamename %>";

const ws = new WebSocket(`ws://${window.location.host}/play`);
const send = (payload) => ws.send(JSON.stringify(payload));
const getel = (id) => document.getElementById(id);

ws.onopen = () => send({action:'join_table', player_name, table, password: ""});
ws.onclose = () => getel('error').innerHTML += 'WARNING: connection closed. Refresh page to reconnect!<br>';

ws.onmessage = (event) => { 
  msg = JSON.parse(event.data);
  if (msg.msg_type !== 'pong') { console.log(msg) }

  if (msg.msg_type === 'game_state') {
    GAME_PHASE = msg.game.phase;

    if (GAME_PHASE === 'lobby') {
      getel('actions').innerHTML = `<button onclick="start_game()">Start Game</button>`
    } else if (GAME_PHASE === 'vote') {
      getel('actions').innerHTML = `
        <button onclick="vote(0)">Order</button>
        <select id="order_suit">
          <option value="H">Hearts</option>
          <option value="D">Diamonds</option>
          <option value="S">Spades</option>
          <option value="C">Clubs</option>
        </select>
        <button onclick="vote(1)">Loner</button>
        <button onclick="pass_kitty()">Pass</button>`
    } else {
      getel('actions').innerHTML = "";
    }

    for (let i = 0; i < 4; i++) {
      if (msg.game.players[i] === "Empty") {
	getel(`s${i}`).innerHTML = "Sit";
	if (SEAT === -1) {
	  getel(`s${i}`).disabled = false;
	}
      } else if (SEAT !== i) {
	getel(`s${i}`).disabled = true;
	getel(`s${i}`).innerHTML = "Taken";
      }
      getel(`s${i}-name`).innerHTML = msg.game.players[i];
      if (msg.game.dealer === i) {
        getel(`s${i}-dealer`).innerHTML = "Dealer"
      } else {
        getel(`s${i}-dealer`).innerHTML = ""
      }
      if (msg.game.caller === i) {
        getel(`s${i}-caller`).innerHTML = "Caller"
      } else {
        getel(`s${i}-caller`).innerHTML = ""
      }
      if (msg.game.turn === i) {
        getel(`seat-${i}`).style["background"] = "#99ff99";
      } else {
        getel(`seat-${i}`).style["background"] = "none";
      }
    }

    if (msg.game.dealer) {
      getel(`s${msg.game.dealer}-dealer`).innerHTML = "Dealer"
    }

    if (typeof msg.game.trump_nominee !== 'undefined') {
      getel('trumpnom').innerHTML = 'Trump Nominee: ' + '<img class="card" src="cards/' + msg.game.trump_nominee + '.svg"><br>'
    }

    if (msg.hand.length > 0) {
      getel('hand').innerHTML = '<p>Your Hand (click to play)</p>'
      for (let i = 0; i < msg.hand.length; i++) {
        const c = msg.hand[i]
        getel('hand').innerHTML += '<img onclick="play(' + "'" +  c + "'" + ')" class="card" src="cards/' + c + '.svg">'
      }
    }

    if (msg.game.table) {
      getel('play').innerHTML = ''
      for (let i = 0; i < msg.game.table.length; i++) {
        let c = msg.game.table[i]
        if (c === null) {
          c = '2B' // show back
        }
        getel('play').innerHTML += '<img class="card" src="cards/' + c + '.svg">'
      }
    } else {
      getel('play').innerHTML = 'No cards on table'
    }
  } else if (msg.msg_type === 'error') {
    getel('error').innerHTML += msg.msg + '<br>'
  } else if (msg.msg_type === 'chat') {
    getel('chat_box').innerHTML += msg.msg + '<br>'
  }
};

function sit(seat) {
  SEAT = seat;
  getel(`s${seat}`).innerHTML = "Stand";
  getel(`s${seat}`).onclick = () => stand(seat);
  for (let i = 0; i < 4; i++) {
    if (i !== seat) {
      getel(`s${i}`).disabled = true;
    }
  }
  send({action:'take_seat', seat })
}
function stand(seat) {
  SEAT = -1;
  getel(`s${seat}`).innerHTML = "Sit";
  getel(`s${seat}`).onclick = () => sit(seat);
  for (let i = 0; i < 4; i++) {
    if (i !== seat) {
      getel(`s${i}`).disabled = false;
    }
  }
  send({action:'stand_up'})
}
function start_game() {
  send({action:'start_game', start_seat: Math.floor(Math.random() * 4) })
}
function vote(a) {
  order_suit = getel('order_suit').value;
  console.log(order_suit);
  send({action:'order', vote: order_suit, loner: a})
}
function pass_kitty() {
  send({action:'order', vote: 'pass'})
}
function play(card) {
  if (GAME_PHASE === 'dealer_swap') {
    send({action:'dealer_swap', card: card})
  } else {
    send({action:'play_card', card: card})
  }
}
function chat() {
  send({action:'chat', msg: getel('chat').value })
  getel('chat').value = '';
}
function leaveGame() {
  send({action:'leave_table'})
}

window.setInterval(() => { send({action:'ping'}) }, 5000);
</script>
  <noscript>
  <p>
  Unfortunately, we don't have a JavaScript free interface.
  Please use a browser supporting ES6 or newer.
  </p>
  </noscript>

  <br><br>
  <div id="gtable">
  <div id="top nav">
  <a href="/">Leave Game</a>
  </div>
  <div id="seat-0">
  <p id="s0-name">Empty</p>
  <button id="s0" onclick="sit(0)">Sit</button>
  <div id="s0-dealer"></div>
  <div id="s0-caller"></div>
  <div id="s0-tricks" class="tricks"></div>
  </div>
  <div id="score">score</div>
  <div id="seat-3">
  <p id="s3-name">Empty</p>
  <button id="s3" onclick="sit(3)">Sit</button>
  <div id="s3-dealer"></div>
  <div id="s3-caller"></div>
  <div id="s3-tricks" class="tricks"></div>
  </div>
  <div id="play">cards</div>
  <div id="seat-1">
  <p id="s1-name">Empty</p>
  <button id="s1" onclick="sit(1)">Sit</button>
  <div id="s1-dealer"></div>
  <div id="s1-caller"></div>
  <div id="s1-tricks" class="tricks"></div>
  </div>
  <div id="trumpnom">trump nom</div>
  <div id="seat-2">
  <p id="s2-name">Empty</p>
  <button id="s2" onclick="sit(2)">Sit</button>
  <div id="s2-dealer"></div>
  <div id="s2-caller"></div>
  <div id="s2-tricks" class="tricks"></div>
  </div>
  <div id="actions"></div>
  </div>
  <br>
  <br>
  <div id="hand"></div>
  <br><br>
  <div id="error" style="color:red"> </div>
